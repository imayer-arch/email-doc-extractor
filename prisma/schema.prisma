// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  name                String?
  image               String?
  
  // Gmail OAuth tokens (encriptados)
  gmailConnected      Boolean   @default(false) @map("gmail_connected")
  gmailAccessToken    String?   @map("gmail_access_token")
  gmailRefreshToken   String?   @map("gmail_refresh_token")
  gmailTokenExpiry    DateTime? @map("gmail_token_expiry")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  documents           ExtractedDocument[]
  processedEmails     ProcessedEmail[]
  
  @@map("users")
}

model ExtractedDocument {
  id             String   @id @default(uuid())
  emailId        String   @map("email_id")
  emailSubject   String?  @map("email_subject")
  emailFrom      String?  @map("email_from")
  emailDate      DateTime? @map("email_date")
  fileName       String   @map("file_name")
  fileType       String?  @map("file_type")
  extractedAt    DateTime @default(now()) @map("extracted_at")
  rawText        String?  @map("raw_text")
  structuredData Json?    @map("structured_data")
  tablesData     Json?    @map("tables_data")
  confidence     Float?   @map("confidence")
  status         String   @default("pending") @map("status")
  errorMessage   String?  @map("error_message")
  notifiedAt     DateTime? @map("notified_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  // Relación con usuario
  userId         String?  @map("user_id")
  user           User?    @relation(fields: [userId], references: [id])

  @@map("extracted_documents")
  @@index([emailId])
  @@index([status])
  @@index([extractedAt])
  @@index([userId])
}

model ProcessedEmail {
  id          String   @id @default(uuid())
  emailId     String   @unique @map("email_id")
  processedAt DateTime @default(now()) @map("processed_at")
  
  // Relación con usuario
  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id])
  
  @@map("processed_emails")
  @@index([userId])
}
